<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dashboard · Family Weather</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<main class="wrap">

<header>
  <div>
    <div class="kicker">Family Weather</div>
    <h1>Plan an event</h1>
    <p class="subtitle">Step 1: verify location (City/State/ZIP). Step 2: create event.</p>
  </div>
  <div class="actions">
    <a class="btn" href="/">Home</a>
    <a class="btn" href="events.html">Events</a>
    <a class="btn" href="settings.html">⚙️ Settings</a>
  
    <a class="btn" id="navDashboard" href="dashboard.html">Dashboard</a>
    <button class="btn" id="navSignOut" type="button">Sign out</button>
</div>
</header>

<section class="grid cols-3">
  <div class="card" style="grid-column: span 2;">
    <h2>Create event</h2>

    <form id="eventForm">
      <div class="muted" style="margin-bottom:10px">Title</div>
      <input id="title" class="input" placeholder="e.g., Family dinner" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff" required>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div>
          <div class="muted" style="margin-bottom:10px">When</div>
          <input id="when" type="datetime-local" class="input" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff" required>
        </div>
        <div>
          <div class="muted" style="margin-bottom:10px">Street (optional)</div>
          <input id="street" class="input" placeholder="533 W 5th St" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff">
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 120px 140px;gap:12px;margin-top:12px">
        <div>
          <div class="muted" style="margin-bottom:10px">City</div>
          <input id="city" class="input" placeholder="Stockton" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff" required>
        </div>
        <div>
          <div class="muted" style="margin-bottom:10px">State</div>
          <input id="state" class="input" placeholder="CA" maxlength="2" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;text-transform:uppercase" required>
        </div>
        <div>
          <div class="muted" style="margin-bottom:10px">ZIP</div>
          <input id="zip" class="input" placeholder="95206" inputmode="numeric" maxlength="10" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff" required>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center">
        <button id="verifyBtn" class="btn" type="button">Verify location</button>
        <span id="verifyState" class="muted">Not verified yet.</span>
      </div>

      <input type="hidden" id="lat">
      <input type="hidden" id="lon">
      <input type="hidden" id="placeLabel">

      <div class="muted" style="margin-top:14px;margin-bottom:10px">Notes (optional)</div>
      <textarea id="notes" rows="3" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff"></textarea>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
        <button id="createBtn" class="btn primary" type="submit" disabled>Create event</button>
      </div>

      <div id="err" class="muted" style="margin-top:10px;color:rgba(239,68,68,.95)"></div>
    </form>
  </div>

  <div class="card">
    <h2>Recent events</h2>
    <div id="recent" class="muted">Loading…</div>
    <div class="muted" style="margin-top:10px;opacity:.85">(Click an event to open it.)</div>
  </div>
</section>

<footer>© <span id="year"></span> Family Weather</footer>
</main>

<script type="module" src="authBox.js"></script>
<script src="apiBox.js"></script>
<script type="module" src="logout.js"></script>
<script src="app.js" defer></script>

<script>
document.getElementById("year").textContent = new Date().getFullYear();

function toast(msg){
  if(window.FW && window.FW.toast) return window.FW.toast(msg);
  alert(msg);
}

function z5(v){ return String(v||"").replace(/[^0-9]/g,"").slice(0,5); }

async function loadRecent(){
  const box = document.getElementById("recent");
  if(!window.FW || !window.FW.listEvents){
    box.textContent = "Events module not ready.";
    return;
  }
  const list = await window.FW.listEvents();
  if(!list || !list.length){
    box.textContent = "No events yet.";
    return;
  }
  box.innerHTML = "";
  list.slice(0,6).forEach(ev => {
    const a = document.createElement("a");
    a.className = "row";
    a.href = `event.html?id=${encodeURIComponent(ev.id)}`;
    a.innerHTML = `<span>${ev.title || "Event"}</span><span style="opacity:.75">${new Date(ev.whenISO).toLocaleDateString()}</span>`;
    box.appendChild(a);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  loadRecent();

  const verifyBtn = document.getElementById("verifyBtn");
  const createBtn = document.getElementById("createBtn");
  const stateEl = document.getElementById("verifyState");
  const errEl = document.getElementById("err");

  verifyBtn.addEventListener("click", async () => {
    errEl.textContent = "";
    createBtn.disabled = true;

    const zip = z5(document.getElementById("zip").value);
    if(!zip){
      errEl.textContent = "ZIP required (5 digits).";
      return;
    }

    stateEl.textContent = "Verifying…";
    try{
      const r = await window.apiBox.geocode(zip);
      document.getElementById("lat").value = r.lat;
      document.getElementById("lon").value = r.lon;
      document.getElementById("placeLabel").value = r.label;
      stateEl.textContent = `✅ ${r.label} (${Number(r.lat).toFixed(4)}, ${Number(r.lon).toFixed(4)})`;
      createBtn.disabled = false;
    }catch(e){
      console.error(e);
      stateEl.textContent = "Not verified.";
      errEl.textContent = "Could not locate ZIP. Try a valid 5-digit US ZIP.";
    }
  });

  document.getElementById("eventForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    errEl.textContent = "";

    const lat = Number(document.getElementById("lat").value);
    const lon = Number(document.getElementById("lon").value);
    if(!Number.isFinite(lat) || !Number.isFinite(lon)){
      errEl.textContent = "Verify location first.";
      return;
    }

    const title = document.getElementById("title").value.trim();
    const whenRaw = document.getElementById("when").value;
    const city = document.getElementById("city").value.trim();
    const st = document.getElementById("state").value.trim().toUpperCase();
    const zip = z5(document.getElementById("zip").value);
    const street = document.getElementById("street").value.trim();
    const notes = document.getElementById("notes").value.trim();

    const whenISO = new Date(whenRaw).toISOString();
    const placeLabel = document.getElementById("placeLabel").value || `${city}, ${st} ${zip}`;
    const place = street ? `${street}, ${placeLabel}` : placeLabel;

    try{
      const ev = await window.FW.createEvent({
        title,
        whenISO,
        place,
        notes,
        lat,
        lon
      });

      toast("Saved.");
      // go to event detail OR events list (your choice)
      if(ev && ev.id) location.href = `event.html?id=${encodeURIComponent(ev.id)}`;
      else location.href = "events.html";
    }catch(err){
      console.error(err);
      errEl.textContent = err && err.message ? err.message : "Could not create event.";
    }
  });
});
</script>
  <script type="module" src="authNav.js"></script>
</body>
</html>
